<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>箭頭挑戰遊戲 (可自訂)</title>
    <!-- 載入 Tailwind CSS 用於快速排版 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 Tone.js 用於產生音效和音樂 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            /* (MODIFIED) 確保 body 不會捲動 */
            overflow: hidden;
        }

        /* (MODIFIED) 遊戲 wrapper 改為填滿全螢幕 */
        #game-wrapper {
            /* 移除舊的 16:9 比例設定 */
            /* width: 100vw; */
            /* height: 56.25vw; */
            /* max-height: 100vh; */
            /* max-width: 177.78vh; */
            /* margin: auto; */
            /* position: absolute; */
            /* top: 50%; */
            /* left: 50%; */
            /* transform: translate(-50%, -50%); */
            
            /* (NEW) 使用 fixed position 填滿整個 viewport */
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            
            overflow: hidden; /* 確保 wrapper 內部不捲動 */
        }

        /* 遊戲中的主要箭頭符號 */
        #arrow {
            font-size: 50vmax; /* 維持 50vmax，這在全螢幕下運作良好 */
            line-height: 1; 
            font-weight: bold;
            text-align: center;
            transform: scale(0) rotate(0deg);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), color 0.3s ease-in-out;
            color: white; 
        }
        
        /* 遊戲畫面，使用 flex 佈局 */
        .game-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        /* 暫停遮罩 */
        #pause-overlay {
            position: absolute;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: none; 
            align-items: center;
            justify-content: center;
            font-size: 5rem;
            font-weight: bold;
            color: white;
            z-index: 99; 
        }

        /* 暫停按鈕容器 */
        #pause-container {
            position: absolute;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 100; 
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen overflow-hidden">

    <!-- (MODIFIED) 遊戲主容器，現在會填滿全螢幕 -->
    <div id="game-wrapper" class="bg-black relative">

        <!-- 暫停按鈕 (預設隱藏) -->
        <div id="pause-container" class="hidden">
            <button id="pause-button" 
                    class="w-16 h-16 bg-yellow-500 hover:bg-yellow-600 text-black rounded-full text-lg font-bold flex items-center justify-center shadow-lg transform transition-transform hover:scale-110">
                暫停
            </button>
        </div>

        <!-- 暫停遮罩 (預設隱藏) -->
        <div id="pause-overlay" class="hidden">
            已暫停
        </div>


        <!-- 畫面 1: 設定畫面 (MODIFIED) -->
        <div id="settings-screen" class="game-screen justify-start absolute inset-0 p-4 md:p-8 space-y-4 z-30 bg-gray-900 overflow-y-auto">
            <h1 class="text-4xl md:text-6xl font-bold text-blue-400">箭頭體智動畫大挑戰</h1>
            <p class="text-xl md:text-2xl text-gray-300">設定你的遊戲參數</p>
            
            <!-- (NEW) 新增作者和書籍連結 -->
            <div class="text-center text-lg text-gray-300 space-y-1">
                <p>
                    設計者：<a href="https://www.facebook.com/chungmenghsiu" target="_blank" rel="noopener noreferrer"
                           class="text-blue-300 hover:text-blue-200 underline">鍾孟修 職能治療師</a>
                </p>
                <p>
                    追蹤粉絲專頁 <a href="https://www.facebook.com/profile.php?id=100063748491881#" target="_blank" rel="noopener noreferrer"
                           class="text-blue-300 hover:text-blue-200 underline">鍾孟修Ｍatt-職能治療師</a>
                </p>
                <p>
                    新書「<a href="https://www.books.com.tw/products/0011022363?sloc=main" target="_blank" rel="noopener noreferrer"
                           class="text-blue-300 hover:text-blue-200 underline">讓你健康不失智的體智能</a>」
                </p>
            </div>

            <!-- 基本設定 -->
            <div class="space-y-4 w-full max-w-sm">
                <div>
                    <label for="total-time" class="block text-lg font-medium text-gray-200 mb-2">
                        遊戲總時間 (秒)
                    </label>
                    <input type="number" id="total-time" value="60" min="10" 
                           class="w-full p-3 bg-gray-800 border border-gray-700 rounded-lg text-white text-xl text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label for="arrow-duration" class="block text-lg font-medium text-gray-200 mb-2">
                        箭頭顯示間隔 (秒)
                    </label>
                    <input type="number" id="arrow-duration" value="3" min="1" step="0.5"
                           class="w-full p-3 bg-gray-800 border border-gray-700 rounded-lg text-white text-xl text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            
            <!-- (NEW) 顏色與動作設定 -->
            <div class="space-y-4 w-full max-w-lg bg-gray-800 p-4 rounded-lg border border-gray-700">
                <h3 class="text-xl font-semibold text-center text-blue-300 mb-3">顏色與動作設定 (至少選一項)</h3>
                
                <!-- 黃色 -->
                <div class="flex items-center space-x-3">
                    <input type="checkbox" id="color-toggle-yellow" class="w-5 h-5 rounded text-blue-500 focus:ring-blue-500" checked>
                    <span class="w-6 h-6 rounded-full" style="background-color: #FACC15;"></span>
                    <label for="color-toggle-yellow" class="text-lg text-yellow-400 w-16 flex-shrink-0">黃色</label>
                    <input type="text" id="color-action-yellow" value="右手比方向" class="flex-1 p-2 bg-gray-700 border border-gray-600 rounded-md text-white text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <!-- 白色 -->
                <div class="flex items-center space-x-3">
                    <input type="checkbox" id="color-toggle-white" class="w-5 h-5 rounded text-blue-500 focus:ring-blue-500" checked>
                    <span class="w-6 h-6 rounded-full border border-gray-400" style="background-color: #FFFFFF;"></span>
                    <label for="color-toggle-white" class="text-lg text-white w-16 flex-shrink-0">白色</label>
                    <input type="text" id="color-action-white" value="左手比方向" class="flex-1 p-2 bg-gray-700 border border-gray-600 rounded-md text-white text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <!-- 紅色 -->
                <div class="flex items-center space-x-3">
                    <input type="checkbox" id="color-toggle-red" class="w-5 h-5 rounded text-blue-500 focus:ring-blue-500" checked>
                    <span class="w-6 h-6 rounded-full" style="background-color: #EF4444;"></span>
                    <label for="color-toggle-red" class="text-lg text-red-400 w-16 flex-shrink-0">紅色</label>
                    <input type="text" id="color-action-red" value="頭轉方向" class="flex-1 p-2 bg-gray-700 border border-gray-600 rounded-md text-white text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <!-- 綠色 -->
                <div class="flex items-center space-x-3">
                    <input type="checkbox" id="color-toggle-green" class="w-5 h-5 rounded text-blue-500 focus:ring-blue-500" checked>
                    <span class="w-6 h-6 rounded-full" style="background-color: #22C55E;"></span>
                    <label for="color-toggle-green" class="text-lg text-green-400 w-16 flex-shrink-0">綠色</label>
                    <input type="text" id="color-action-green" value="嘴巴說方向" class="flex-1 p-2 bg-gray-700 border border-gray-600 rounded-md text-white text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <!-- (NEW) 錯誤訊息 -->
            <div id="settings-error" class="text-red-400 text-lg font-medium hidden">
                請至少選擇一種箭頭顏色！
            </div>
            
            <button id="start-button" 
                    class="px-10 py-4 bg-blue-600 hover:bg-blue-700 rounded-lg text-2xl font-bold transition-transform transform hover:scale-105 shadow-lg">
                開始遊戲
            </button>
        </div>

        <!-- 畫面 2: 說明畫面 (MODIFIED) -->
        <div id="instructions-screen" class="game-screen absolute inset-0 p-8 space-y-4 z-20 bg-gray-900 hidden">
            <h2 class="text-4xl md:text-5xl font-bold text-yellow-400 mb-4">遊戲玩法</h2>
            
            <!-- (MODIFIED) 動態說明列表 -->
            <ul id="dynamic-instructions-list" class="space-y-3 text-left max-w-2xl mx-auto text-lg md:text-2xl">
                <!-- 內容將由 JS 動態填入 -->
            </ul>
            
            <!-- 遊戲動畫開始按鈕 -->
            <button id="start-animation-button" 
                    class="mt-6 px-8 py-3 bg-green-600 hover:bg-green-700 rounded-lg text-xl font-bold transition-transform transform hover:scale-105 shadow-lg">
                遊戲動畫開始
            </button>
            
            <!-- 倒數計時文字，預設隱藏 -->
            <div id="countdown-text" class="text-5xl md:text-7xl font-bold text-white pt-8 hidden">
                5
            </div>
        </div>

        <!-- 畫面 3: 遊戲主畫面 -->
        <div id="game-screen" class="game-screen absolute inset-0 p-8 z-10 bg-black hidden">
            <!-- 遊戲計時器 -->
            <div id="game-timer" class="absolute top-4 right-6 text-3xl md:text-5xl font-bold text-white bg-black bg-opacity-50 px-4 py-2 rounded-lg">
                時間: 60
            </div>
            
            <!-- 箭頭本體 -->
            <div id="arrow">&rarr;</div>
        </div>

        <!-- 畫面 4: 遊戲結束畫面 -->
        <div id="game-over-screen" class="game-screen absolute inset-0 p-8 space-y-8 z-20 bg-gray-900 hidden">
            <h2 class="text-6xl md:text-8xl font-bold text-blue-400">遊戲結束!</h2>
            <p class="text-2xl md:text-3xl text-gray-300">做得好！</p>
            
            <button id="play-again-button" 
                    class="px-10 py-4 bg-blue-600 hover:bg-blue-700 rounded-lg text-2xl font-bold transition-transform transform hover:scale-105 shadow-lg">
                再玩一次
            </button>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ... (取得 DOM 元素) ...
            const settingsScreen = document.getElementById('settings-screen');
            const instructionsScreen = document.getElementById('instructions-screen');
            const gameScreen = document.getElementById('game-screen');
            const gameOverScreen = document.getElementById('game-over-screen');
            const pauseContainer = document.getElementById('pause-container');
            const pauseButton = document.getElementById('pause-button');
            const pauseOverlay = document.getElementById('pause-overlay');
            const totalTimeInput = document.getElementById('total-time');
            const arrowDurationInput = document.getElementById('arrow-duration');
            const startButton = document.getElementById('start-button');
            const playAgainButton = document.getElementById('play-again-button');
            const startAnimationButton = document.getElementById('start-animation-button');
            const countdownText = document.getElementById('countdown-text');
            const gameTimerText = document.getElementById('game-timer');
            const arrow = document.getElementById('arrow');
            const settingsError = document.getElementById('settings-error');
            const dynamicInstructionsList = document.getElementById('dynamic-instructions-list');
            
            // ... (遊戲狀態變數) ...
            let totalTime = 60;
            let arrowDuration = 3;
            let gameTimerInterval = null;
            let gameLoopInterval = null;
            let countdownInterval = null; 
            let currentTimer = 0;
            let isGameRunning = false; 
            let isGameStarting = false; 
            let isPaused = false;
            let countdown = 5;

            // ... (箭頭設定) ...
            const arrowColors = { 'yellow': '#FACC15', 'white': '#FFFFFF', 'red': '#EF4444', 'green': '#22C55E' };
            const colorChineseNames = { 'yellow': '黃色', 'white': '白色', 'red': '紅色', 'green': '綠色' };
            const colorNames = Object.keys(arrowColors);
            let gameSettings = {};
            let activeColorNames = [];
            const directions = [ 0, 90, 180, 270 ];

            // ... (音效設定) ...
            let isAudioReady = false;
            let hitSynth; 
            async function setupAudio() {
                if (isAudioReady) return;
                await Tone.start(); 
                hitSynth = new Tone.MembraneSynth({
                    pitchDecay: 0.05, octaves: 10, oscillator: { type: "sine" },
                    envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.4, attackCurve: "exponential" }
                }).toDestination();
                isAudioReady = true;
                console.log("音效已準備就緒");
            }

            // ... (showScreen 函數) ...
            function showScreen(screenElement) {
                [settingsScreen, instructionsScreen, gameScreen, gameOverScreen].forEach(s => s.classList.add('hidden'));
                screenElement.classList.remove('hidden');
                if (screenElement === instructionsScreen) {
                    startAnimationButton.classList.remove('hidden'); 
                    countdownText.classList.add('hidden'); 
                    countdownText.innerText = "5"; 
                    pauseContainer.classList.remove('hidden'); 
                } else if (screenElement === gameScreen) {
                    pauseContainer.classList.remove('hidden'); 
                } else {
                    pauseContainer.classList.add('hidden');
                    pauseOverlay.style.display = 'none'; 
                    isPaused = false;
                    pauseButton.innerText = "暫停";
                }
            }

            // --- 遊戲流程控制 ---

            // 0. 暫停/繼續 邏輯
            const handleTogglePause = () => {
                isPaused = !isPaused;
                if (isPaused) {
                    pauseButton.innerText = "繼續";
                    pauseOverlay.style.display = 'flex'; 
                    if (countdownInterval) clearInterval(countdownInterval);
                    if (gameTimerInterval) clearInterval(gameTimerInterval);
                    if (gameLoopInterval) clearInterval(gameLoopInterval);
                } else {
                    pauseButton.innerText = "暫停";
                    pauseOverlay.style.display = 'none'; 
                    if (!instructionsScreen.classList.contains('hidden') && !countdownText.classList.contains('hidden')) {
                        startCountdownTimer(); 
                    } else if (!gameScreen.classList.contains('hidden')) {
                        gameTimerInterval = setInterval(updateGameTimer, 1000);
                        gameLoopInterval = setInterval(generateArrow, arrowDuration * 1000);
                    }
                }
            }
            // (MODIFIED) 綁定暫停按鈕事件
            pauseButton.addEventListener('click', handleTogglePause);
            pauseButton.addEventListener('touchstart', (e) => {
                e.preventDefault(); // 防止 click 重複觸發
                handleTogglePause();
            });


            // ... (updateGameSettings 函數) ...
            function updateGameSettings() {
                gameSettings = {};
                activeColorNames = [];
                settingsError.classList.add('hidden'); 
                for (const color of colorNames) { 
                    const toggle = document.getElementById(`color-toggle-${color}`);
                    const actionInput = document.getElementById(`color-action-${color}`);
                    if (toggle.checked) {
                        const action = actionInput.value.trim(); 
                        activeColorNames.push(color);
                        gameSettings[color] = {
                            action: action || `[${colorChineseNames[color]}]`, 
                            hex: arrowColors[color],
                            name: colorChineseNames[color]
                        };
                    }
                }
                if (activeColorNames.length === 0) {
                    settingsError.classList.remove('hidden');
                    return false; 
                }
                return true; 
            }

            // ... (populateInstructions 函數) ...
            function populateInstructions() {
                dynamicInstructionsList.innerHTML = ''; 
                for (const color of activeColorNames) {
                    const data = gameSettings[color];
                    const li = document.createElement('li');
                    li.className = "flex items-center space-x-3";
                    const borderClass = (color === 'white') ? 'border-2 border-gray-400' : '';
                    li.innerHTML = `
                        <span class="w-6 h-6 rounded-full flex-shrink-0 ${borderClass}" style="background-color: ${data.hex};"></span>
                        <span>
                            <strong style="color: ${data.hex};">${data.name}箭頭:</strong> 
                            <span class="text-gray-300">${data.action}</span>
                        </span>
                    `;
                    dynamicInstructionsList.appendChild(li);
                }
            }


            // 1. 點擊「開始遊戲」按鈕 (MODIFIED)
            const handleStartGame = async () => {
                if (isGameStarting) return;
                isGameStarting = true; 
                try {
                    if (!isAudioReady) {
                        await setupAudio();
                    }
                } catch (err) {
                    console.error("音效初始化失敗:", err);
                    isGameStarting = false;
                    return;
                }
                totalTime = parseInt(totalTimeInput.value, 10) || 60;
                arrowDuration = parseFloat(arrowDurationInput.value) || 3;
                if (!updateGameSettings()) {
                    isGameStarting = false; 
                    return; 
                }
                populateInstructions();
                showScreen(instructionsScreen);
            };
            startButton.addEventListener('click', handleStartGame);
            startButton.addEventListener('touchstart', (e) => {
                e.preventDefault();
                handleStartGame();
            });


            // 1.5. 點擊「遊戲動畫開始」按鈕 (MODIFIED)
            const handleStartAnimation = () => {
                startAnimationButton.classList.add('hidden');
                countdownText.classList.remove('hidden');
                countdown = 5; 
                countdownText.innerText = "5";
                if (isAudioReady) hitSynth.triggerAttackRelease("C3", "8n"); 
                startCountdownTimer(); 
            };
            startAnimationButton.addEventListener('click', handleStartAnimation);
            startAnimationButton.addEventListener('touchstart', (e) => {
                e.preventDefault();
                handleStartAnimation();
            });


            // 1.6. 倒數計時器函數 (可被暫停)
            function startCountdownTimer() {
                if (countdownInterval) clearInterval(countdownInterval); 
                countdownInterval = setInterval(() => {
                    countdown--; 
                    if (countdown > 0) {
                        countdownText.innerText = countdown;
                        if (isAudioReady) hitSynth.triggerAttackRelease("C3", "8n");
                    } else {
                        clearInterval(countdownInterval);
                        countdownInterval = null; 
                        countdownText.innerText = "GO!";
                        if (isAudioReady) hitSynth.triggerAttackRelease("C4", "4n"); 
                        setTimeout(startGame, 500);
                    }
                }, 1000);
            }


            // 2. 開始遊戲
            function startGame() {
                isGameStarting = false; 
                isGameRunning = true; 
                currentTimer = totalTime;
                gameTimerText.innerText = `時間: ${currentTimer}`;
                showScreen(gameScreen);
                gameTimerInterval = setInterval(updateGameTimer, 1000);
                generateArrow(); 
                gameLoopInterval = setInterval(generateArrow, arrowDuration * 1000);
            }

            // 3. 更新遊戲計時器
            function updateGameTimer() {
                currentTimer--;
                gameTimerText.innerText = `時間: ${currentTimer}`;
                if (currentTimer <= 0) {
                    endGame(); 
                }
            }

            // 4. 產生新箭頭
            function generateArrow() {
                if (!isGameRunning) return;
                if (activeColorNames.length === 0) {
                    console.error("沒有可用的顏色！遊戲無法產生箭頭。");
                    endGame(); 
                    return; 
                }
                const randomColorName = activeColorNames[Math.floor(Math.random() * activeColorNames.length)];
                const randomDirection = directions[Math.floor(Math.random() * directions.length)];
                const colorHex = arrowColors[randomColorName];
                arrow.style.transform = 'scale(0) rotate(0deg)'; 
                setTimeout(() => {
                    if (!isGameRunning) return;
                    arrow.style.color = colorHex;
                    arrow.style.transform = `scale(0.85) rotate(${randomDirection}deg)`; 
                    if (isAudioReady) {
                        hitSynth.triggerAttackRelease("G2", "8n");
                    }
                }, 200); 
            }

            // 5. 結束遊戲
            function endGame() {
                isGameRunning = false; 
                if (gameTimerInterval) clearInterval(gameTimerInterval);
                if (gameLoopInterval) clearInterval(gameLoopInterval);
                if (countdownInterval) clearInterval(countdownInterval); 
                gameTimerInterval = null; 
                gameLoopInterval = null; 
                countdownInterval = null; 
                arrow.style.transform = 'scale(0)';
                showScreen(gameOverScreen);
            }

            // 6. 點擊「再玩一次」 (MODIFIED)
            const handlePlayAgain = () => {
                showScreen(settingsScreen);
                isGameRunning = false; 
                isGameStarting = false; 
                countdownText.innerText = "5";
                if (gameTimerInterval) clearInterval(gameTimerInterval);
                if (gameLoopInterval) clearInterval(gameLoopInterval);
                if (countdownInterval) clearInterval(countdownInterval);
                gameTimerInterval = null;
                gameLoopInterval = null;
                countdownInterval = null;
            };
            playAgainButton.addEventListener('click', handlePlayAgain);
            playAgainButton.addEventListener('touchstart', (e) => {
                e.preventDefault();
                handlePlayAgain();
            });

            // 初始顯示設定畫面
            showScreen(settingsScreen);
        });
    </script>
</body>
</html>

