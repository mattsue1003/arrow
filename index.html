<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>箭頭挑戰遊戲 (可自訂)</title>
    <!-- 載入 Tailwind CSS 用於快速排版 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 Tone.js 用於產生音效和音樂 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        #game-wrapper {
            width: 100vw;
            height: 56.25vw; /* 16:9 aspect ratio (9 / 16 = 0.5625) */
            max-height: 100vh;
            max-width: 177.78vh; /* 16:9 aspect ratio (16 / 9 = 1.7778) */
            margin: auto;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            overflow: hidden;
        }

        /* 遊戲中的主要箭頭符號 */
        #arrow {
            font-size: 50vmax; /* 使用 vmax 讓箭頭大小隨視窗縮放 */
            line-height: 1; /* 調整行高讓符號置中 */
            font-weight: bold;
            text-align: center;
            /* 初始狀態為隱藏 (縮放為 0) */
            transform: scale(0) rotate(0deg);
            /* 添加流暢的過場動畫 */
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), color 0.3s ease-in-out;
            color: white; /* 預設顏色 */
        }
        
        /* 遊戲畫面，使用 flex 佈局 */
        .game-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        /* 暫停遮罩 */
        #pause-overlay {
            position: absolute;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: none; /* 預設為 'none' */
            align-items: center;
            justify-content: center;
            font-size: 5rem;
            font-weight: bold;
            color: white;
            z-index: 99; /* 必須高於遊戲畫面 (10) 但低於按鈕 (100) */
        }

        /* 暫停按鈕容器 */
        #pause-container {
            position: absolute;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 100; /* 確保在最上層 */
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen overflow-hidden">

    <!-- 16:9 遊戲主容器 -->
    <div id="game-wrapper" class="bg-black rounded-lg shadow-2xl relative">

        <!-- 暫停按鈕 (預設隱藏) -->
        <div id="pause-container" class="hidden">
            <button id="pause-button" 
                    class="w-16 h-16 bg-yellow-500 hover:bg-yellow-600 text-black rounded-full text-lg font-bold flex items-center justify-center shadow-lg transform transition-transform hover:scale-110">
                暫停
            </button>
        </div>

        <!-- 暫停遮罩 (預設隱藏) -->
        <div id="pause-overlay" class="hidden">
            已暫停
        </div>


        <!-- 畫面 1: 設定畫面 (MODIFIED) -->
        <div id="settings-screen" class="game-screen justify-start absolute inset-0 p-4 md:p-8 space-y-4 z-30 bg-gray-900 overflow-y-auto">
            <h1 class="text-4xl md:text-6xl font-bold text-blue-400">箭頭挑戰</h1>
            <p class="text-xl md:text-2xl text-gray-300">設定你的遊戲參數</p>
            
            <!-- (NEW) 新增作者和書籍連結 -->
            <div class="text-center text-lg text-gray-300 space-y-1">
                <p>
                    設計者：<a href="https://www.facebook.com/chungmenghsiu" target="_blank" rel="noopener noreferrer"
                           class="text-blue-300 hover:text-blue-200 underline">鍾孟修 職能治療師</a>
                </p>
                <p>
                    新書「<a href="https://www.books.com.tw/products/0011022363?sloc=main" target="_blank" rel="noopener noreferrer"
                           class="text-blue-300 hover:text-blue-200 underline">讓你健康不失智的體智能</a>」
                </p>
            </div>

            <!-- 基本設定 -->
            <div class="space-y-4 w-full max-w-sm">
                <div>
                    <label for="total-time" class="block text-lg font-medium text-gray-200 mb-2">
                        遊戲總時間 (秒)
                    </label>
                    <input type="number" id="total-time" value="60" min="10" 
                           class="w-full p-3 bg-gray-800 border border-gray-700 rounded-lg text-white text-xl text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label for="arrow-duration" class="block text-lg font-medium text-gray-200 mb-2">
                        箭頭顯示間隔 (秒)
                    </label>
                    <input type="number" id="arrow-duration" value="3" min="1" step="0.5"
                           class="w-full p-3 bg-gray-800 border border-gray-700 rounded-lg text-white text-xl text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            
            <!-- (NEW) 顏色與動作設定 -->
            <div class="space-y-4 w-full max-w-lg bg-gray-800 p-4 rounded-lg border border-gray-700">
                <h3 class="text-xl font-semibold text-center text-blue-300 mb-3">顏色與動作設定 (至少選一項)</h3>
                
                <!-- 黃色 -->
                <div class="flex items-center space-x-3">
                    <input type="checkbox" id="color-toggle-yellow" class="w-5 h-5 rounded text-blue-500 focus:ring-blue-500" checked>
                    <span class="w-6 h-6 rounded-full" style="background-color: #FACC15;"></span>
                    <label for="color-toggle-yellow" class="text-lg text-yellow-400 w-16 flex-shrink-0">黃色</label>
                    <input type="text" id="color-action-yellow" value="右手比方向" class="flex-1 p-2 bg-gray-700 border border-gray-600 rounded-md text-white text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <!-- 白色 -->
                <div class="flex items-center space-x-3">
                    <input type="checkbox" id="color-toggle-white" class="w-5 h-5 rounded text-blue-500 focus:ring-blue-500" checked>
                    <span class="w-6 h-6 rounded-full border border-gray-400" style="background-color: #FFFFFF;"></span>
                    <label for="color-toggle-white" class="text-lg text-white w-16 flex-shrink-0">白色</label>
                    <input type="text" id="color-action-white" value="左手比方向" class="flex-1 p-2 bg-gray-700 border border-gray-600 rounded-md text-white text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <!-- 紅色 -->
                <div class="flex items-center space-x-3">
                    <input type="checkbox" id="color-toggle-red" class="w-5 h-5 rounded text-blue-500 focus:ring-blue-500" checked>
                    <span class="w-6 h-6 rounded-full" style="background-color: #EF4444;"></span>
                    <label for="color-toggle-red" class="text-lg text-red-400 w-16 flex-shrink-0">紅色</label>
                    <input type="text" id="color-action-red" value="頭轉方向" class="flex-1 p-2 bg-gray-700 border border-gray-600 rounded-md text-white text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <!-- 綠色 -->
                <div class="flex items-center space-x-3">
                    <input type="checkbox" id="color-toggle-green" class="w-5 h-5 rounded text-blue-500 focus:ring-blue-500" checked>
                    <span class="w-6 h-6 rounded-full" style="background-color: #22C55E;"></span>
                    <label for="color-toggle-green" class="text-lg text-green-400 w-16 flex-shrink-0">綠色</label>
                    <input type="text" id="color-action-green" value="嘴巴說方向" class="flex-1 p-2 bg-gray-700 border border-gray-600 rounded-md text-white text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <!-- (NEW) 錯誤訊息 -->
            <div id="settings-error" class="text-red-400 text-lg font-medium hidden">
                請至少選擇一種箭頭顏色！
            </div>
            
            <button id="start-button" 
                    class="px-10 py-4 bg-blue-600 hover:bg-blue-700 rounded-lg text-2xl font-bold transition-transform transform hover:scale-105 shadow-lg">
                開始遊戲
            </button>
        </div>

        <!-- 畫面 2: 說明畫面 (MODIFIED) -->
        <div id="instructions-screen" class="game-screen absolute inset-0 p-8 space-y-4 z-20 bg-gray-900 hidden">
            <h2 class="text-4xl md:text-5xl font-bold text-yellow-400 mb-4">遊戲玩法</h2>
            
            <!-- (MODIFIED) 動態說明列表 -->
            <ul id="dynamic-instructions-list" class="space-y-3 text-left max-w-2xl mx-auto text-lg md:text-2xl">
                <!-- 內容將由 JS 動態填入 -->
            </ul>
            
            <!-- 遊戲動畫開始按鈕 -->
            <button id="start-animation-button" 
                    class="mt-6 px-8 py-3 bg-green-600 hover:bg-green-700 rounded-lg text-xl font-bold transition-transform transform hover:scale-105 shadow-lg">
                遊戲動畫開始
            </button>
            
            <!-- 倒數計時文字，預設隱藏 -->
            <div id="countdown-text" class="text-5xl md:text-7xl font-bold text-white pt-8 hidden">
                5
            </div>
        </div>

        <!-- 畫面 3: 遊戲主畫面 -->
        <div id="game-screen" class="game-screen absolute inset-0 p-8 z-10 bg-black hidden">
            <!-- 遊戲計時器 -->
            <div id="game-timer" class="absolute top-4 right-6 text-3xl md:text-5xl font-bold text-white bg-black bg-opacity-50 px-4 py-2 rounded-lg">
                時間: 60
            </div>
            
            <!-- 箭頭本體 -->
            <div id="arrow">&rarr;</div>
        </div>

        <!-- 畫面 4: 遊戲結束畫面 -->
        <div id="game-over-screen" class="game-screen absolute inset-0 p-8 space-y-8 z-20 bg-gray-900 hidden">
            <h2 class="text-6xl md:text-8xl font-bold text-blue-400">遊戲結束!</h2>
            <p class="text-2xl md:text-3xl text-gray-300">做得好！</p>
            
            <button id="play-again-button" 
                    class="px-10 py-4 bg-blue-600 hover:bg-blue-700 rounded-lg text-2xl font-bold transition-transform transform hover:scale-105 shadow-lg">
                再玩一次
            </button>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 取得所有 DOM 元素
            const settingsScreen = document.getElementById('settings-screen');
            const instructionsScreen = document.getElementById('instructions-screen');
            const gameScreen = document.getElementById('game-screen');
            const gameOverScreen = document.getElementById('game-over-screen');

            // 暫停功能元素
            const pauseContainer = document.getElementById('pause-container');
            const pauseButton = document.getElementById('pause-button');
            const pauseOverlay = document.getElementById('pause-overlay');
            
            const totalTimeInput = document.getElementById('total-time');
            const arrowDurationInput = document.getElementById('arrow-duration');
            
            const startButton = document.getElementById('start-button');
            const playAgainButton = document.getElementById('play-again-button');
            const startAnimationButton = document.getElementById('start-animation-button');
            
            const countdownText = document.getElementById('countdown-text');
            const gameTimerText = document.getElementById('game-timer');
            const arrow = document.getElementById('arrow');

            // (NEW) 設定畫面的新元素
            const settingsError = document.getElementById('settings-error');
            const dynamicInstructionsList = document.getElementById('dynamic-instructions-list');

            // 遊戲狀態變數
            let totalTime = 60;
            let arrowDuration = 3;
            let gameTimerInterval = null;
            let gameLoopInterval = null;
            let countdownInterval = null; 
            let currentTimer = 0;
            let isGameRunning = false; 
            let isGameStarting = false; 

            // 暫停和倒數計時狀態
            let isPaused = false;
            let countdown = 5;

            // --- (MODIFIED) 箭頭設定 ---
            // 顏色 (使用 Tailwind 顏色)
            const arrowColors = {
                'yellow': '#FACC15', // yellow-400
                'white': '#FFFFFF',
                'red': '#EF4444',   // red-500
                'green': '#22C55E'  // green-500
            };
            // (NEW) 顏色中文名稱
            const colorChineseNames = {
                'yellow': '黃色',
                'white': '白色',
                'red': '紅色',
                'green': '綠色'
            };
            const colorNames = Object.keys(arrowColors); // ['yellow', 'white', 'red', 'green']
            
            // (NEW) 遊戲進行中使用的設定
            let gameSettings = {};
            let activeColorNames = [];

            // 方向 (CSS 旋轉角度)
            const directions = [
                0,   // 右
                90,  // 下
                180, // 左
                270  // 上
            ];

            // --- 音效設定 (Tone.js) ---
            let isAudioReady = false;
            let hitSynth; 

            async function setupAudio() {
                if (isAudioReady) return;
                
                await Tone.start(); // 啟動音訊上下文
                
                // 箭頭出現的音效
                hitSynth = new Tone.MembraneSynth({
                    pitchDecay: 0.05,
                    octaves: 10,
                    oscillator: { type: "sine" },
                    envelope: {
                        attack: 0.001,
                        decay: 0.4,
                        sustain: 0.01,
                        release: 1.4,
                        attackCurve: "exponential"
                    }
                }).toDestination();
                
                isAudioReady = true;
                console.log("音效已準備就緒");
            }

            // --- 畫面切換邏輯 ---

            // 顯示指定的畫面
            function showScreen(screenElement) {
                // 隱藏所有畫面
                [settingsScreen, instructionsScreen, gameScreen, gameOverScreen].forEach(s => {
                    s.classList.add('hidden');
                });
                // 顯示指定畫面
                screenElement.classList.remove('hidden');

                // 處理說明畫面的按鈕/文字顯示
                if (screenElement === instructionsScreen) {
                    startAnimationButton.classList.remove('hidden'); // 顯示按鈕
                    countdownText.classList.add('hidden'); // 隱藏倒數
                    countdownText.innerText = "5"; // 重置文字
                    pauseContainer.classList.remove('hidden'); // 顯示暫停按鈕
                } else if (screenElement === gameScreen) {
                    pauseContainer.classList.remove('hidden'); // 顯示暫停按鈕
                } else {
                    // 在設定或結束畫面，強制隱藏暫停功能並重置狀態
                    pauseContainer.classList.add('hidden');
                    pauseOverlay.style.display = 'none'; 
                    isPaused = false;
                    pauseButton.innerText = "暫停";
                }
            }

            // --- 遊戲流程控制 ---

            // 0. 暫停/繼續 邏輯
            function togglePause() {
                isPaused = !isPaused;

                if (isPaused) {
                    // 暫停
                    pauseButton.innerText = "繼續";
                    pauseOverlay.style.display = 'flex'; 

                    // 清除所有計時器
                    if (countdownInterval) clearInterval(countdownInterval);
                    if (gameTimerInterval) clearInterval(gameTimerInterval);
                    if (gameLoopInterval) clearInterval(gameLoopInterval);

                } else {
                    // 繼續
                    pauseButton.innerText = "暫停";
                    pauseOverlay.style.display = 'none'; 
                    
                    // 1. 我們在說明畫面的倒數計時中 (且倒數文字是可見的)
                    if (!instructionsScreen.classList.contains('hidden') && !countdownText.classList.contains('hidden')) {
                        startCountdownTimer(); // 繼續倒數
                    } 
                    // 2. 我們在主遊戲中
                    else if (!gameScreen.classList.contains('hidden')) {
                        gameTimerInterval = setInterval(updateGameTimer, 1000);
                        gameLoopInterval = setInterval(generateArrow, arrowDuration * 1000);
                    }
                }
            }
            // 綁定暫停按鈕事件
            pauseButton.addEventListener('click', togglePause);


            // (NEW) 1.a. 從設定畫面讀取並驗證設定
            function updateGameSettings() {
                gameSettings = {};
                activeColorNames = [];
                settingsError.classList.add('hidden'); // 先隱藏錯誤

                for (const color of colorNames) { // colorNames is ['yellow', 'white', ...]
                    const toggle = document.getElementById(`color-toggle-${color}`);
                    const actionInput = document.getElementById(`color-action-${color}`);
                    
                    if (toggle.checked) {
                        const action = actionInput.value.trim(); // 去除前後空白
                        activeColorNames.push(color);
                        gameSettings[color] = {
                            // 如果使用者清空了文字，提供一個預設值
                            action: action || `[${colorChineseNames[color]}]`, 
                            hex: arrowColors[color],
                            name: colorChineseNames[color]
                        };
                    }
                }

                // 錯誤檢查：必須至少選一個
                if (activeColorNames.length === 0) {
                    settingsError.classList.remove('hidden');
                    return false; // 回傳 false 表示失敗
                }
                
                return true; // 回傳 true 表示成功
            }

            // (NEW) 1.b. 根據設定動態產生說明
            function populateInstructions() {
                dynamicInstructionsList.innerHTML = ''; // 清空

                for (const color of activeColorNames) {
                    const data = gameSettings[color];
                    
                    const li = document.createElement('li');
                    li.className = "flex items-center space-x-3";
                    
                    // 處理白色箭頭的邊框
                    const borderClass = (color === 'white') ? 'border-2 border-gray-400' : '';

                    li.innerHTML = `
                        <span class="w-6 h-6 rounded-full flex-shrink-0 ${borderClass}" style="background-color: ${data.hex};"></span>
                        <span>
                            <strong style="color: ${data.hex};">${data.name}箭頭:</strong> 
                            <span class="text-gray-300">${data.action}</span>
                        </span>
                    `;
                    dynamicInstructionsList.appendChild(li);
                }
            }


            // 1. 點擊「開始遊戲」按鈕 (MODIFIED)
            startButton.addEventListener('click', async () => {
                if (isGameStarting) return;
                isGameStarting = true; 

                try {
                    // 初始化音效 (必須由用戶操作觸發)
                    if (!isAudioReady) {
                        await setupAudio();
                    }
                } catch (err) {
                    console.error("音效初始化失敗:", err);
                    isGameStarting = false;
                    return;
                }

                // 獲取基本設定值
                totalTime = parseInt(totalTimeInput.value, 10) || 60;
                arrowDuration = parseFloat(arrowDurationInput.value) || 3;
                
                // (NEW) 1. 更新並驗證遊戲設定
                if (!updateGameSettings()) {
                    isGameStarting = false; // 重置
                    return; // 驗證失敗，停止
                }

                // (NEW) 2. 產生動態說明
                populateInstructions();

                // (EXISTING) 3. 顯示說明畫面
                showScreen(instructionsScreen);
            });

            // 1.5. 點擊「遊戲動畫開始」按鈕
            startAnimationButton.addEventListener('click', () => {
                // 隱藏自己，顯示倒數文字
                startAnimationButton.classList.add('hidden');
                countdownText.classList.remove('hidden');

                countdown = 5; // 重置倒數計時
                countdownText.innerText = "5";
                if (isAudioReady) hitSynth.triggerAttackRelease("C3", "8n"); // 播放 '5' 的聲音
                
                startCountdownTimer(); // 呼叫獨立的計時器函數
            });

            // 1.6. 倒數計時器函數 (可被暫停)
            function startCountdownTimer() {
                if (countdownInterval) clearInterval(countdownInterval); // 清除舊的

                countdownInterval = setInterval(() => {
                    countdown--; // 倒數 4, 3, 2, 1...
                    if (countdown > 0) {
                        countdownText.innerText = countdown;
                        // 倒數音效
                        if (isAudioReady) hitSynth.triggerAttackRelease("C3", "8n");
                    } else {
                        // 倒數結束 (countdown is 0)
                        clearInterval(countdownInterval);
                        countdownInterval = null; // 清除 ID
                        countdownText.innerText = "GO!";
                        // 準備音效
                        if (isAudioReady) hitSynth.triggerAttackRelease("C4", "4n"); 
                        // 稍待一會，然後開始遊戲
                        setTimeout(startGame, 500);
                    }
                }, 1000);
            }


            // 2. 開始遊戲
            function startGame() {
                isGameStarting = false; 
                isGameRunning = true; 
                currentTimer = totalTime;
                gameTimerText.innerText = `時間: ${currentTimer}`;
                showScreen(gameScreen);

                // 啟動遊戲計時器 (每秒更新)
                gameTimerInterval = setInterval(updateGameTimer, 1000);
                
                // 啟動遊戲主循環 (產生箭頭)
                // 立刻產生第一個箭頭
                generateArrow(); 
                gameLoopInterval = setInterval(generateArrow, arrowDuration * 1000);
            }

            // 3. 更新遊戲計時器
            function updateGameTimer() {
                currentTimer--;
                gameTimerText.innerText = `時間: ${currentTimer}`;
                
                if (currentTimer <= 0) {
                    endGame(); // 時間到，結束遊戲
                }
            }

            // 4. 產生新箭頭 (MODIFIED)
            function generateArrow() {
                if (!isGameRunning) return;

                // (NEW) 檢查是否有可用的顏色
                if (activeColorNames.length === 0) {
                    console.error("沒有可用的顏色！遊戲無法產生箭頭。");
                    endGame(); // 沒有顏色，強制結束遊戲
                    return; 
                }

                // (MODIFIED) 隨機選擇 "已啟用" 的顏色
                const randomColorName = activeColorNames[Math.floor(Math.random() * activeColorNames.length)];
                const randomDirection = directions[Math.floor(Math.random() * directions.length)];
                
                const colorHex = arrowColors[randomColorName];

                // 先縮小箭頭 (製造 "消失" 效果)
                arrow.style.transform = 'scale(0) rotate(0deg)'; // 復位旋轉再縮小
                
                // 延遲短暫時間後，顯示新箭頭
                setTimeout(() => {
                    if (!isGameRunning) return;

                    // 設置新箭頭的顏色和方向
                    arrow.style.color = colorHex;
                    arrow.style.transform = `scale(0.85) rotate(${randomDirection}deg)`; // 縮放 0.85 (不要滿版)
                    
                    // 播放箭頭出現音效
                    if (isAudioReady) {
                        hitSynth.triggerAttackRelease("G2", "8n");
                    }
                }, 200); // 0.2 秒後出現
            }

            // 5. 結束遊戲
            function endGame() {
                isGameRunning = false; 

                // 清除所有計時器
                if (gameTimerInterval) clearInterval(gameTimerInterval);
                if (gameLoopInterval) clearInterval(gameLoopInterval);
                if (countdownInterval) clearInterval(countdownInterval); 
                gameTimerInterval = null; 
                gameLoopInterval = null; 
                countdownInterval = null; 
                
                // 隱藏箭頭
                arrow.style.transform = 'scale(0)';
                
                // 顯示結束畫面
                showScreen(gameOverScreen);
            }

            // 6. 點擊「再玩一次」
            playAgainButton.addEventListener('click', () => {
                showScreen(settingsScreen);
                isGameRunning = false; 
                isGameStarting = false; 
                // 重置倒數計時文字
                countdownText.innerText = "5";
                // 確保清除殘留的計時器
                if (gameTimerInterval) clearInterval(gameTimerInterval);
                if (gameLoopInterval) clearInterval(gameLoopInterval);
                if (countdownInterval) clearInterval(countdownInterval);
                gameTimerInterval = null;
                gameLoopInterval = null;
                countdownInterval = null;
            });

            // 初始顯示設定畫面
            showScreen(settingsScreen);
        });
    </script>
</body>
</html>


